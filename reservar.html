<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#050508">
  <title>Reservar ‚Äì COLESTUR</title>

  <style>
    :root {
      --bg: #050508;
      --card: #0c0d11;
      --card-soft: #13141b;
      --accent: #3a7ce9;
      --text: #f4f6f9;
      --muted: #9ca3b5;
      --border: #1c1d25;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      color: var(--text);
    }

    /* HEADER igual que index */
    header {
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(10,10,14,0.9);
      border-bottom: 1px solid #0e1015;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo-circle {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ffeaa7, #f1c40f);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111;
      font-weight: 800;
    }

    .brand-label {
      font-size: 12px;
      color: var(--muted);
    }

    .brand-name {
      font-size: 18px;
      font-weight: 700;
    }

    /* MAIN con espacio extra para barra inferior */
    main {
      padding: 20px 16px 140px;
      max-width: 780px;
      margin: auto;
    }

    .trip-card {
      background: var(--card);
      padding: 18px;
      border-radius: 18px;
      border: 1px solid var(--border);
      margin-bottom: 22px;
    }

    label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      display: block;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border-radius: 14px;
      background: var(--card-soft);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }

    input::placeholder {
      color: #6f7485;
    }

    #map {
      width: 100%;
      height: 300px;
      border-radius: 18px;
      margin-bottom: 18px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .info-box {
      background: var(--card);
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      margin-top: -8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 14px;
    }

    .info-label {
      opacity: .85;
    }

    /* BOT√ìN CONFIRMAR (flotante sobre la barra) */
    .confirm-container {
      position: fixed;
      bottom: 75px;
      left: 0;
      right: 0;
      padding: 0 18px;
      display: flex;
      justify-content: center;
      z-index: 9999;
    }

    .btn-confirm {
      width: 100%;
      background: var(--accent);
      padding: 15px;
      border: none;
      border-radius: 999px;
      color: white;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 12px 28px rgba(58,124,233,.45);
      cursor: pointer;
    }

    /* BOTTOM NAV igual en todas las p√°ginas */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 65px;
      background: #0d0e12;
      border-top: 1px solid #1f2027;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 9998;
    }

    .nav-item {
      text-align: center;
      color: #9ca3b5;
      font-size: 13px;
      text-decoration: none;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .nav-item span {
      font-size: 20px;
      margin-bottom: 2px;
    }

    .nav-active {
      color: #ffffff;
      font-weight: 600;
    }

    /* Mensaje reserva (si lo usas) */
    #mensajeReserva {
      margin-top: 10px;
      font-size: 13px;
      min-height: 18px;
    }
  </style>
</head>

<body>

<header>
  <div class="logo-circle">CR</div>
  <div>
    <div class="brand-label">TRANSPORTE ESPECIAL</div>
    <div class="brand-name">COLESTUR S.A.S.</div>
  </div>
</header>

<main>

  <!-- Origen / Destino -->
  <section class="trip-card">
    <label>Punto de recogida</label>
    <input id="origen" placeholder="Cargando ubicaci√≥n..." />

    <label style="margin-top:14px;">Destino</label>
    <input id="destino" placeholder="¬øA d√≥nde vas?" />
  </section>

  <!-- Mapa -->
  <div id="map"></div>

  <!-- Distancia / Tiempo -->
  <div class="info-box">
    <div>
      <span class="info-label">üìç Distancia:</span>
      <span id="distancia">‚Äî</span>
    </div>
    <div>
      <span class="info-label">‚è± Tiempo estimado:</span>
      <span id="tiempo">‚Äî</span>
    </div>
  </div>

  <!-- Datos del pasajero -->
  <section class="trip-card">
    <label>Nombre completo</label>
    <input id="nombre" />

    <label style="margin-top:12px;">WhatsApp</label>
    <input id="telefono" type="tel" placeholder="57300..." />

    <label style="margin-top:12px;">Servicio</label>
    <select id="servicio">
      <option>Escolar</option>
      <option>Empresarial</option>
      <option>Turismo</option>
      <option>Aeropuerto</option>
    </select>

    <label style="margin-top:12px;">Fecha</label>
    <input type="date" id="fecha">

    <label style="margin-top:12px;">Hora</label>
    <input type="time" id="hora">

    <label style="margin-top:12px;">Pasajeros</label>
    <input type="number" id="pasajeros" value="1" min="1">

    <p id="mensajeReserva"></p>
  </section>

  <!-- Coords ocultas -->
  <input type="hidden" id="origen_lat">
  <input type="hidden" id="origen_lng">
  <input type="hidden" id="destino_lat">
  <input type="hidden" id="destino_lng">

</main>

<!-- Bot√≥n Confirmar -->
<div class="confirm-container">
  <button id="btnReservar" class="btn-confirm">Confirmar reserva</button>
</div>

<!-- Bottom nav -->
<nav class="bottom-nav">
  <a href="index.html" class="nav-item">
    <span>üè†</span>
    Inicio
  </a>
  <a href="reservar.html" class="nav-item nav-active">
    <span>üöå</span>
    Reservar
  </a>
  <a href="contacto.html" class="nav-item">
    <span>üìû</span>
    Contacto
  </a>
</nav>

<!-- ========== L√ìGICA DE MAPA / RUTA / DISTANCIA / TIEMPO ========== -->
<script>
  let map, originMarker, destMarker, directionsService, directionsRenderer;

  function initMap() {
    const origenInput   = document.getElementById("origen");
    const destinoInput  = document.getElementById("destino");
    const distSpan      = document.getElementById("distancia");
    const timeSpan      = document.getElementById("tiempo");
    const oLatInput     = document.getElementById("origen_lat");
    const oLngInput     = document.getElementById("origen_lng");
    const dLatInput     = document.getElementById("destino_lat");
    const dLngInput     = document.getElementById("destino_lng");

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers: true,
      polylineOptions: {
        strokeColor: "#3a7ce9",
        strokeWeight: 6
      }
    });

    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 4.711, lng: -74.0721 }, // Bogot√°
      zoom: 13,
      disableDefaultUI: true
    });

    directionsRenderer.setMap(map);

    const geocoder = new google.maps.Geocoder();

    // 1) GEOLOCALIZACI√ìN: centro del mapa y punto de recogida
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const loc = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };

          map.setCenter(loc);
          map.setZoom(15);

          setOriginLoc(loc);

          // Convertir coords a direcci√≥n, pero sin borrar lo que el usuario escriba luego
          geocoder.geocode({ location: loc }, (res, status) => {
            if (status === "OK" && res[0] && !origenInput.value) {
              origenInput.value = res[0].formatted_address;
            }
          });
        },
        (err) => {
          console.log("No se pudo obtener la ubicaci√≥n:", err);
        },
        { enableHighAccuracy: true }
      );
    }

    // 2) AUTOCOMPLETE (solo Colombia, sesgado a la zona del usuario)
    const options = {
      componentRestrictions: { country: "co" },
      fields: ["formatted_address", "geometry", "name"]
    };

    const acOrigen  = new google.maps.places.Autocomplete(origenInput, options);
    const acDestino = new google.maps.places.Autocomplete(destinoInput, options);

    // Sesgar por cercan√≠a seg√∫n el centro actual del mapa
    google.maps.event.addListenerOnce(map, "idle", () => {
      const bounds = map.getBounds();
      if (bounds) {
        acOrigen.setBounds(bounds);
        acDestino.setBounds(bounds);
      }
    });

    acOrigen.addListener("place_changed", () => {
      const place = acOrigen.getPlace();
      if (!place.geometry) return;

      // NO sobreescribo el texto que t√∫ escribiste (dejamos "Centro Comercial Fontanar", etc.)
      const loc = {
        lat: place.geometry.location.lat(),
        lng: place.geometry.location.lng()
      };
      setOriginLoc(loc);
      calcularRuta();
    });

    acDestino.addListener("place_changed", () => {
      const place = acDestino.getPlace();
      if (!place.geometry) return;

      // Igual: NO cambio el texto, solo uso coords para la ruta
      const loc = {
        lat: place.geometry.location.lat(),
        lng: place.geometry.location.lng()
      };
      setDestinoLoc(loc);
      calcularRuta();
    });

    // Helpers para marcar origen/destino
    function setOriginLoc(loc) {
      oLatInput.value = loc.lat;
      oLngInput.value = loc.lng;

      if (!originMarker) {
        originMarker = new google.maps.Marker({
          map,
          position: loc,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: "#3a7ce9",
            fillOpacity: 1,
            strokeColor: "#ffffff",
            strokeWeight: 2
          }
        });
      } else {
        originMarker.setPosition(loc);
      }
    }

    function setDestinoLoc(loc) {
      dLatInput.value = loc.lat;
      dLngInput.value = loc.lng;

      if (!destMarker) {
        destMarker = new google.maps.Marker({
          map,
          position: loc,
          icon: {
            path: "M 0 0 L 3 6 L 0 14 L -3 6 Z",
            fillColor: "#4bff8f",
            fillOpacity: 1,
            strokeColor: "#111217",
            strokeWeight: 2
          }
        });
      } else {
        destMarker.setPosition(loc);
      }
    }

    // Calcula y dibuja la ruta + distancia/tiempo
    function calcularRuta() {
      const oLat = parseFloat(oLatInput.value);
      const oLng = parseFloat(oLngInput.value);
      const dLat = parseFloat(dLatInput.value);
      const dLng = parseFloat(dLngInput.value);

      if (isNaN(oLat) || isNaN(oLng) || isNaN(dLat) || isNaN(dLng)) {
        return;
      }

      const origin      = new google.maps.LatLng(oLat, oLng);
      const destination = new google.maps.LatLng(dLat, dLng);

      directionsService.route(
        {
          origin,
          destination,
          travelMode: google.maps.TravelMode.DRIVING,
          drivingOptions: {
            departureTime: new Date(),  // ahora
            trafficModel: google.maps.TrafficModel.BEST_GUESS
          }
        },
        (result, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(result);

            const leg = result.routes[0].legs[0];
            distSpan.textContent = leg.distance ? leg.distance.text : "‚Äî";
            if (leg.duration_in_traffic) {
              timeSpan.textContent = leg.duration_in_traffic.text;
            } else if (leg.duration) {
              timeSpan.textContent = leg.duration.text;
            } else {
              timeSpan.textContent = "‚Äî";
            }
          } else {
            console.log("Error al calcular ruta:", status);
          }
        }
      );
    }

    // Exponemos calcularRuta por si quisieras llamarla desde fuera
    window._calcularRutaColestur = calcularRuta;

    // ----- BOT√ìN CONFIRMAR -----
    const btnReservar  = document.getElementById("btnReservar");
    const mensajeReserva = document.getElementById("mensajeReserva");

    btnReservar.addEventListener("click", () => {
      // Validaciones b√°sicas
      if (
        !origenInput.value.trim() ||
        !destinoInput.value.trim() ||
        !document.getElementById("nombre").value.trim() ||
        !document.getElementById("telefono").value.trim() ||
        !document.getElementById("fecha").value ||
        !document.getElementById("hora").value
      ) {
        if (mensajeReserva) {
          mensajeReserva.style.color = "#ff5a5f";
          mensajeReserva.textContent = "Por favor completa todos los campos.";
        }
        return;
      }
<!-- ==================== SCRIPTS ===================== -->

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCq3TY2xt3MZHPUWEcFJhCEWfaWplAf1es",
  authDomain: "colestur-reservas.firebaseapp.com",
  projectId: "colestur-reservas",
  storageBucket: "colestur-reservas.appspot.com",
  messagingSenderId: "73404287419",
  appId: "1:73404287419:web:1dd4fe4a1692a4e28f271f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.guardarReserva = async function (data) {
  await addDoc(collection(db, "reservas"), data);
};
</script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
emailjs.init("oQlbFJ4zYcGqzOqYx");
</script>

      // Aqu√≠ SO-LO preparamos los datos.
      // Tu l√≥gica de Firebase + EmailJS que YA FUNCIONABA la puedes pegar aqu√≠ dentro:
      // -----------------------------------------------------------------
      // Ejemplo (NO obligatorio si ya lo tienes en un <script type='module'> aparte):
      // guardar en Firestore + enviar correo...
      // -----------------------------------------------------------------

      if (mensajeReserva) {
        mensajeReserva.style.color = "#42ba96";
        mensajeReserva.textContent = "Reserva registrada. Un asesor de COLESTUR te contactar√° pronto.";
      }
    });
  }

  // Hacer accesible la funci√≥n de callback al script de Google
  window.initMap = initMap;
</script>

<!-- Script de Google Maps: OJO que sea HTTPS y con 'places' -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD32zkRd46s5jKHkTjj2868WOMfv7m_V48&libraries=places&callback=initMap" async defer></script>

<!-- Si ya ten√≠as tu script type="module" con Firebase + EmailJS, ponlo aqu√≠ debajo sin cambiarlo -->
<!--
<script type="module">
  // ...TU C√ìDIGO FIREBASE + EMAILJS QUE YA FUNCIONABA...
</script>
-->

</body>
</html>
