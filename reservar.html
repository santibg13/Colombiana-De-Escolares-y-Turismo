<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Reservar ‚Äì COLESTUR</title>

<style>
  :root {
    --bg: #050508;
    --card: #0c0d11;
    --card-soft: #13141b;
    --accent: #3a7ce9;
    --text: #f4f6f9;
    --muted: #9ca3b5;
    --border: #1c1d25;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    background: var(--bg);
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    color: var(--text);
  }

  /* HEADER */
  header {
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(10,10,14,0.6);
    border-bottom: 1px solid #0e1015;
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .logo-circle {
    width: 38px;
    height: 38px;
    border-radius: 999px;
    background: linear-gradient(135deg, #ffeaa7, #f1c40f);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #111;
    font-weight: 800;
  }

  main {
    padding: 20px 16px 140px;
    max-width: 780px;
    margin: auto;
  }

  .trip-card {
    background: var(--card);
    padding: 18px;
    border-radius: 18px;
    border: 1px solid var(--border);
    margin-bottom: 22px;
  }

  label {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 6px;
    display: block;
  }

  input, select {
    width: 100%;
    padding: 12px;
    border-radius: 14px;
    background: var(--card-soft);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 14px;
  }

  input::placeholder {
    color: #6b6f7a;
  }

  #map {
    width: 100%;
    height: 300px;
    border-radius: 18px;
    margin-bottom: 18px;
    border: 1px solid var(--border);
  }

  .info-box {
    background: var(--card);
    padding: 14px;
    border-radius: 14px;
    border: 1px solid var(--border);
    margin-top: -8px;
    margin-bottom: 20px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 14px;
  }

  .info-label {
    font-weight: 600;
  }

  /* BOTTOM NAV */
  .bottom-nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: #0d0e12;
    border-top: 1px solid #1f2027;
    padding: 10px 0 8px;
    display: flex;
    justify-content: space-around;
    z-index: 9999;
  }

  .nav-item {
    text-align: center;
    font-size: 13px;
    color: var(--muted);
    text-decoration: none;
  }

  .nav-item span {
    font-size: 20px;
    display: block;
    margin-bottom: 2px;
  }

  .nav-active {
    color: white;
    font-weight: 600;
  }

  /* BOT√ìN CONFIRMAR */
  .confirm-container {
    position: fixed;
    bottom: 70px;
    left: 0;
    right: 0;
    padding: 0 18px;
    display: flex;
    justify-content: center;
    z-index: 9999;
  }

  .btn-confirm {
    width: 100%;
    max-width: 780px;
    background: var(--accent);
    padding: 15px;
    border: none;
    border-radius: 999px;
    color: white;
    font-weight: 700;
    font-size: 16px;
    box-shadow: 0 12px 28px rgba(58,124,233,.45);
    cursor: pointer;
  }

  /* Mensaje de confirmaci√≥n / error */
  #mensajeReserva {
    margin-top: 12px;
    font-size: 14px;
    min-height: 20px;
  }

  /* Autocomplete por encima de todo */
  .pac-container {
    z-index: 10000 !important;
  }

  html, body {
    background: #050508 !important;
}/* Evitar que los inputs de fecha y hora se salgan del cuadro en iOS */
input[type="date"],
input[type="time"] {
    height: 48px !important;
    padding-left: 14px !important;
    padding-right: 14px !important;
    appearance: none;
    -webkit-appearance: none;
    line-height: normal !important;
}
</style>
</head>

<body>

<header>
  <div class="logo-circle">CR</div>
  <div>
    <div style="font-size:12px;color:var(--muted)">TRANSPORTE ESPECIAL</div>
    <div style="font-size:18px;font-weight:700">COLESTUR S.A.S.</div>
  </div>
</header>

<main>

  <section class="trip-card">
    <label>Punto de recogida</label>
    <input id="origen" placeholder="Cargando ubicaci√≥n..." />

    <label style="margin-top:14px;">Destino</label>
    <input id="destino" placeholder="¬øA d√≥nde vas?" />
  </section>

  <div id="map"></div>

  <div class="info-box">
    <div>üìç <span class="info-label">Distancia:</span> <span id="distancia">‚Äî</span></div>
    <div>‚è± <span class="info-label">Tiempo estimado:</span> <span id="tiempo">‚Äî</span></div>
  </div>

  <section class="trip-card">
    <label>Nombre completo</label>
    <input id="nombre" />

    <label style="margin-top:12px;">WhatsApp</label>
    <input id="telefono" type="tel" placeholder="57300..." />

    <label style="margin-top:12px;">Servicio</label>
    <select id="servicio">
      <option>Escolar</option>
      <option>Empresarial</option>
      <option>Turismo</option>
      <option>Aeropuerto</option>
    </select>

    <label style="margin-top:12px;">Fecha</label>
    <input type="date" id="fecha">

    <label style="margin-top:12px;">Hora</label>
    <input type="time" id="hora">

    <label style="margin-top:12px;">Pasajeros</label>
    <input type="number" id="pasajeros" value="1" min="1">

    <p id="mensajeReserva"></p>
  </section>

  <!-- COORDENADAS -->
  <input type="hidden" id="origen_lat">
  <input type="hidden" id="origen_lng">
  <input type="hidden" id="destino_lat">
  <input type="hidden" id="destino_lng">

</main>

<!-- BOT√ìN CONFIRMAR -->
<div class="confirm-container">
  <button id="btnReservar" class="btn-confirm">Confirmar reserva</button>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <a href="index.html" class="nav-item">
    <span>üè†</span> Inicio
  </a>

  <a href="reservar.html" class="nav-item nav-active">
    <span>üöå</span> Reservar
  </a>

  <a href="contacto.html" class="nav-item">
    <span>üìû</span> Contacto
  </a>
</div>

<!-- ===================== EMAILJS ===================== -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  (function () {
    emailjs.init("BBBTYChL9Rq9ynJgJ"); // TU PUBLIC KEY DE EMAILJS
  })();
</script>

<!-- ===================== FIREBASE + GUARDAR RESERVA ===================== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCpuX28qe2YFhX2rSzH01AIPP9EQDIsP94",
    authDomain: "colestur-reservas.firebaseapp.com",
    projectId: "colestur-reservas",
    storageBucket: "colestur-reservas.firebasestorage.app",
    messagingSenderId: "123689903908",
    appId: "1:123689903908:web:d4d710d7165e64a369f5b1",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const btn = document.getElementById("btnReservar");
  const msg = document.getElementById("mensajeReserva");

  const nombre = document.getElementById("nombre");
  const telefono = document.getElementById("telefono");
  const servicio = document.getElementById("servicio");
  const origen = document.getElementById("origen");
  const destino = document.getElementById("destino");
  const fecha = document.getElementById("fecha");
  const hora = document.getElementById("hora");
  const pasajeros = document.getElementById("pasajeros");

  btn.addEventListener("click", async () => {
    msg.style.color = "#f4f6f9";
    msg.textContent = "Enviando reserva...";

    if (!origen.value.trim() || !destino.value.trim() ||
        !nombre.value.trim() || !telefono.value.trim() ||
        !fecha.value || !hora.value) {
      msg.style.color = "#ff5a5f";
      msg.textContent = "Por favor completa todos los campos obligatorios.";
      return;
    }

    const reserva = {
      nombre: nombre.value.trim(),
      telefono: telefono.value.trim(),
      servicio: servicio.value,
      origen: origen.value.trim(),
      destino: destino.value.trim(),
      fecha: fecha.value,
      hora: hora.value,
      pasajeros: Number(pasajeros.value || 1),
      origen_lat: parseFloat(document.getElementById("origen_lat").value) || null,
      origen_lng: parseFloat(document.getElementById("origen_lng").value) || null,
      destino_lat: parseFloat(document.getElementById("destino_lat").value) || null,
      destino_lng: parseFloat(document.getElementById("destino_lng").value) || null,
      distancia: document.getElementById("distancia").textContent,
      tiempo_estimado: document.getElementById("tiempo").textContent,
      estado: "Pendiente",
      creadaEn: serverTimestamp(),
      fuente: "PWA COLESTUR"
    };

    try {
      // 1) Guardar en Firestore
      await addDoc(collection(db, "reservas"), reserva);

      // 2) Enviar correo con EmailJS
      await emailjs.send("service_bsdpr26", "template_fmqabdi", {
        to_email: "santibg13@gmail.com",
        nombre: reserva.nombre,
        telefono: reserva.telefono,
        servicio: reserva.servicio,
        origen: reserva.origen,
        destino: reserva.destino,
        fecha: reserva.fecha,
        hora: reserva.hora,
        pasajeros: reserva.pasajeros,
        distancia: reserva.distancia,
        tiempo_estimado: reserva.tiempo_estimado
      });

      msg.style.color = "#42ba96";
      msg.textContent = "‚úî Tu reserva fue registrada con √©xito. Un asesor de COLESTUR te contactar√° pronto.";

      destino.value = "";
      fecha.value = "";
      hora.value = "";
      pasajeros.value = "1";

    } catch (err) {
      console.error(err);
      msg.style.color = "#ff5a5f";
      msg.textContent = "‚ùå Ocurri√≥ un error al registrar la reserva. Intenta de nuevo.";
    }
  });
</script>

<!-- ===================== MAPAS / RUTA / TIEMPO ===================== -->
<script>
let map, originMarker, destMarker, directionsService, directionsRenderer, distanceMatrix;

function initMap() {
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({
    suppressMarkers: true,
    polylineOptions:{ strokeColor:"#3a7ce9", strokeWeight:6 }
  });
  distanceMatrix = new google.maps.DistanceMatrixService();

  map = new google.maps.Map(document.getElementById("map"), {
    center:{ lat:4.71, lng:-74.07 },
    zoom:14,
    disableDefaultUI:true
  });

  directionsRenderer.setMap(map);

  const geocoder = new google.maps.Geocoder();

  // GEOLOCALIZACI√ìN: origen real
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        document.getElementById("origen_lat").value = lat;
        document.getElementById("origen_lng").value = lng;

        placeOriginMarker(lat, lng);
        map.setCenter({lat, lng});

        geocoder.geocode({ location:{lat, lng} }, (res, status) => {
          if (status === "OK" && res[0]) {
            document.getElementById("origen").value = res[0].formatted_address;
          } else {
            document.getElementById("origen").value = "Mi ubicaci√≥n actual";
          }
        });
      },
      () => {
        console.log("No se pudo obtener la ubicaci√≥n.");
      }
    );
  }

  // AUTOCOMPLETE
  const acOrigen = new google.maps.places.Autocomplete(
    document.getElementById("origen"),
    {
      fields:["formatted_address","geometry","name"],
      componentRestrictions:{ country:"co" }
    }
  );

  const acDestino = new google.maps.places.Autocomplete(
    document.getElementById("destino"),
    {
      fields:["formatted_address","geometry","name"],
      componentRestrictions:{ country:"co" }
    }
  );

  acOrigen.addListener("place_changed", () => {
    const p = acOrigen.getPlace();
    if (!p.geometry) return;
    updateOrigin(p);
    calcularRuta();
  });

  acDestino.addListener("place_changed", () => {
    const p = acDestino.getPlace();
    if (!p.geometry) return;
    updateDestino(p);
    calcularRuta();
  });
}

function updateOrigin(place){
  const lat = place.geometry.location.lat();
  const lng = place.geometry.location.lng();

  document.getElementById("origen_lat").value = lat;
  document.getElementById("origen_lng").value = lng;

  const texto = place.name || place.formatted_address || "";
  document.getElementById("origen").value = texto;

  placeOriginMarker(lat, lng);
}

function updateDestino(place){
  const lat = place.geometry.location.lat();
  const lng = place.geometry.location.lng();

  document.getElementById("destino_lat").value = lat;
  document.getElementById("destino_lng").value = lng;

  const texto = place.name || place.formatted_address || "";
  document.getElementById("destino").value = texto;

  placeDestinationMarker(lat, lng);
}

function placeOriginMarker(lat,lng){
  const pos = {lat,lng};
  if (!originMarker) {
    originMarker = new google.maps.Marker({
      position: pos,
      map,
      icon:{
        path:google.maps.SymbolPath.CIRCLE,
        scale:8,
        fillColor:"#3a7ce9",
        fillOpacity:1,
        strokeColor:"#fff",
        strokeWeight:2
      }
    });
  } else {
    originMarker.setPosition(pos);
  }
}

function placeDestinationMarker(lat,lng){
  const pos = {lat,lng};
  if (!destMarker) {
    destMarker = new google.maps.Marker({
      position: pos,
      map,
      icon:{
        path:"M 0 0 L 2 4 L 0 12 L -2 4 Z",
        fillColor:"#4bff8f",
        fillOpacity:1,
        strokeColor:"#111217",
        strokeWeight:2
      }
    });
  } else {
    destMarker.setPosition(pos);
  }
}

function calcularRuta() {
  const oLat = parseFloat(document.getElementById("origen_lat").value);
  const oLng = parseFloat(document.getElementById("origen_lng").value);
  const dLat = parseFloat(document.getElementById("destino_lat").value);
  const dLng = parseFloat(document.getElementById("destino_lng").value);

  if (isNaN(oLat) || isNaN(oLng) || isNaN(dLat) || isNaN(dLng)) return;

  const origenCoord = { lat:oLat, lng:oLng };
  const destinoCoord = { lat:dLat, lng:dLng };

  directionsService.route(
    {
      origin: origenCoord,
      destination: destinoCoord,
      travelMode: google.maps.TravelMode.DRIVING
    },
    (res, status) => {
      if (status === "OK") {
        directionsRenderer.setDirections(res);

        const bounds = new google.maps.LatLngBounds();
        bounds.extend(origenCoord);
        bounds.extend(destinoCoord);
        map.fitBounds(bounds);

        distanceMatrix.getDistanceMatrix(
          {
            origins:[origenCoord],
            destinations:[destinoCoord],
            travelMode: google.maps.TravelMode.DRIVING,
            drivingOptions:{
              departureTime: new Date(),
              trafficModel: google.maps.TrafficModel.BEST_GUESS
            }
          },
          (dmRes, dmStatus) => {
            if (dmStatus === "OK") {
              const elem = dmRes.rows[0].elements[0];
              const distText = elem.distance ? elem.distance.text : "‚Äî";
              const timeText =
                (elem.duration_in_traffic && elem.duration_in_traffic.text) ||
                (elem.duration && elem.duration.text) ||
                "‚Äî";

              document.getElementById("distancia").textContent = distText;
              document.getElementById("tiempo").textContent = timeText;
            }
          }
        );
      }
    }
  );
}

window.initMap = initMap;
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD32zkRd46s5jKHkTjj2868WOMfv7m_V48&libraries=places&callback=initMap" async defer></script>

</body>
</html>
